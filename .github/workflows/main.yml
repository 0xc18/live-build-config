name: Build and Release

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y git simple-cdd cdebootstrap curl p7zip python3-pip
          pip3 install --quiet internetarchive

      - name: Install Kali keyring & live-build
        run: |
          wget -q https://http.kali.org/pool/main/k/kali-archive-keyring/kali-archive-keyring_2025.1_all.deb
          wget -q https://http.kali.org/pool/main/l/live-build/live-build_20250505%2Bkali1_all.deb
          sudo apt install -y ./live-build_*_all.deb ./kali-archive-keyring_*_all.deb

      - name: Build ISO image
        run: sudo ./build.sh --verbose --variant custom

      - name: Compute MD5 & rename artifact
        id: md5
        run: |
          FILE=$(ls images/*.iso | head -n1)
          HASH=$(md5sum "$FILE" | cut -d' ' -f1)
          NEW_FILE="${FILE%.*}_${HASH}.${FILE##*.}"
          sudo mv "$FILE" "$NEW_FILE"
          ITEM_ID="${NEW_FILE%.*}"
          DOWNLOAD_URL="https://archive.org/download/$ITEM_ID/$NEW_FILE"
          echo "file=$NEW_FILE" >> "$GITHUB_OUTPUT"
          echo "tag=$HASH" >> "$GITHUB_OUTPUT"
          echo "item=$ITEM_ID" >> "$GITHUB_OUTPUT"
          echo "url=$DOWNLOAD_URL" >> "$GITHUB_OUTPUT"

      - name: Upload to Internet Archive
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          ia upload "${{ steps.md5.outputs.item }}" "${{ steps.md5.outputs.file }}" \
            --metadata="title=${{ steps.md5.outputs.file }}" \
            --metadata="mediatype=data"

      - name: Create GitHub Release with IA URL
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ steps.md5.outputs.tag }}"
          body: |
            ðŸš€ ISO file is too large to attach directly.

            ðŸ”— [Click here to download the image from Internet Archive](${{ steps.md5.outputs.url }})

            **MD5 hash:** `${{ steps.md5.outputs.tag }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
